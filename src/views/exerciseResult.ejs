<html lang="zh">
<head>
    <style>
        .quz-item {
            margin-bottom: 20px;
            background-color: #ffffff;
            line-height: 2rem;
            -webkit-transition: all .3s;
            -moz-transition: all .3s;
            -o-transition: all .3s;
            transition: all .3s;
        }

        .quz-item:hover {
            box-shadow: 1px 2px 4px 0 #888888;
        }

        .quz-tag {
            font-family: "Sarasa Mono HC", "Droid Sans Mono", "monospace", ".SF NS Mono", serif;
            background: #fbfdffb5;
            border-radius: 4px;
            border: solid 1px #dedede;
            color: #8c939a;
            padding: 0 8px;
            margin-left: 8px;
            font-size: .875rem;
        }

        .quz-tag-collect {
            font-family: "Sarasa Mono HC", "Droid Sans Mono", "monospace", ".SF NS Mono", serif;
            background: rgb(16, 142, 233);
            border-radius: 4px;
            border: solid 1px #dedede;
            color: #fff;
            padding: 0 8px;
            margin-left: 8px;
            font-size: .875rem;
        }

        .quz-tag-note {
            font-family: "Sarasa Mono HC", "Droid Sans Mono", "monospace", ".SF NS Mono", serif;
            background: rgb(38, 16, 233);
            border-radius: 4px;
            border: solid 1px #dedede;
            color: #fff;
            padding: 0 8px;
            margin-left: 8px;
            font-size: .875rem;
        }

        .quz-tag-note-method {
            font-family: "Sarasa Mono HC", "Droid Sans Mono", "monospace", ".SF NS Mono", serif;
            background: #ff5200;
            border-radius: 4px;
            border: solid 1px #dedede;
            color: #fff;
            padding: 0 8px;
            margin-left: 8px;
            font-size: .875rem;
        }

        .quz-tag-note-rethink {
            font-family: "Sarasa Mono HC", "Droid Sans Mono", "monospace", ".SF NS Mono", serif;
            background: #e31313;
            border-radius: 4px;
            border: solid 1px #dedede;
            color: #fff;
            padding: 0 8px;
            margin-left: 8px;
            font-size: .875rem;
        }

        .quz-tag-note-acc {
            font-family: "Sarasa Mono HC", "Droid Sans Mono", "monospace", ".SF NS Mono", serif;
            background: #36943b;
            border-radius: 4px;
            border: solid 1px #dedede;
            color: #fff;
            padding: 0 8px;
            margin-left: 8px;
            font-size: .875rem;
        }

        .quz-tag-word {
            cursor: pointer;
            font-family: "Sarasa Mono HC", "Droid Sans Mono", "monospace", ".SF NS Mono", serif;
            background: #8a8a8a;
            border-radius: 4px;
            border: solid 1px #dedede;
            color: #fff;
            padding: 0 8px;
            margin-left: 8px;
            font-size: .875rem;
            -webkit-transition: all .3s cubic-bezier(.645, .045, .355, 1);
            transition: all .3s cubic-bezier(.645, .045, .355, 1);
        }

        .quz-tag-word:hover {
            cursor: pointer;
            font-family: "Sarasa Mono HC", "Droid Sans Mono", "monospace", ".SF NS Mono", serif;
            background: #6b6a6a;
            border-radius: 4px;
            border: solid 1px #dedede;
            color: #fff;
            padding: 0 8px;
            margin-left: 8px;
            font-size: .875rem;
        }

        .quz-tag-correct {
            font-family: "Sarasa Mono HC", "Droid Sans Mono", "monospace", ".SF NS Mono", serif;
            background: #f1f8ff;
            border-radius: 4px;
            color: #3792fd;
            padding: 0 8px;
            margin-left: 8px;
            font-size: .875rem;
        }

        .quz-tag-correct:after {
            content: '我做对了';
        }

        .quz-tag-wrong {
            font-family: "Sarasa Mono HC", "Droid Sans Mono", "monospace", ".SF NS Mono", serif;
            background: #ffc3c3;
            color: rgba(206, 57, 57, 0.79);
            border-radius: 4px;
            padding: 0 8px;
            margin-left: 8px;
            font-size: .875rem;
        }

        .quz-tag-wrong:after {
            content: '我做错了';
        }

        .quz-title-correct {
            font-family: "Sarasa Mono HC", "Droid Sans Mono", "monospace", ".SF NS Mono", serif;
            color: #2d2d2ddb;
            padding: 0 8px;
            font-size: .875rem;
            cursor: pointer;
            background-image: linear-gradient(to right, #bdddff, #ffffff);
        }

        .quz-title-timeout {
            font-family: "Sarasa Mono HC", "Droid Sans Mono", "monospace", ".SF NS Mono", serif;
            color: #2d2d2ddb;
            padding: 0 8px;
            font-size: .875rem;
            cursor: pointer;
            background-image: linear-gradient(to right, rgba(255, 140, 0, 0.7), #ffffff);
        }

        .quz-title-wrong {
            font-family: "Sarasa Mono HC", "Droid Sans Mono", "monospace", ".SF NS Mono", serif;
            color: #2d2d2ddb;
            padding: 0 8px;
            font-size: .875rem;
            cursor: pointer;
            background-image: linear-gradient(to right, rgba(206, 57, 57, 0.55), #ffffff);
        }

        .quz-content {
            font-weight: 500;
            color: #3c464f;
            padding: 0 40px 10px 40px;
        }

        .quz-content p {
            margin: 0;
        }

        .quz-options {
            padding: 0 40px 0 40px;
            color: rgba(60, 70, 79, 0.92);
        }

        .quz-idx {
            padding-left: 10px;
            position: absolute;
        }

        .quz-content-fold {
            padding-bottom: 10px;
            padding-top: 10px;
        }

        .quz-tag-group {
            float: right;
        }

        a {
            text-decoration: none;
            color: #2385f7;
        }

        .solution-btn {
            text-decoration: none;
            border: 1px solid #d9d9d9;
            -webkit-box-shadow: 0 2px 0 rgba(0, 0, 0, .015);
            box-shadow: 0 2px 0 rgba(0, 0, 0, .015);
            cursor: pointer;
            -webkit-transition: all .3s cubic-bezier(.645, .045, .355, 1);
            transition: all .3s cubic-bezier(.645, .045, .355, 1);
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -ms-touch-action: manipulation;
            touch-action: manipulation;
            height: 32px;
            padding: 4px 15px;
            font-size: 14px;
            border-radius: 2px;
            color: rgba(0, 0, 0, .65);
            background: #fff;
            -moz-transition: all .3s;
            -o-transition: all .3s;
            margin-right: 10px;
        }

        .solution-btn:hover {
            color: #40a9ff;
            background: #fff;
            border-color: #40a9ff;
        }

        .noselect {
            -webkit-touch-callout: none; /* iOS Safari */

            -webkit-user-select: none; /* Chrome/Safari/Opera */

            -khtml-user-select: none; /* Konqueror */

            -moz-user-select: none; /* Firefox */

            -ms-user-select: none; /* Internet Explorer/Edge */

            user-select: none;
        }

        .wrong-count {
            color: red;
            font-size: 28px;
            padding: 0 5px 0 5px;
        }

        .collect-count {
            color: #0099ff;
            font-size: 28px;
            padding: 0 5px 0 5px;
        }

        .cost-count {
            color: darkorange;
            font-size: 28px;
            padding: 0 5px 0 5px;
        }

        .comment {
            color: #8c939a;
        }

        /*80~100*/
        .quz-tag-1 {
            font-family: "Sarasa Mono HC", "Droid Sans Mono", "monospace", ".SF NS Mono", serif;
            border-radius: 1px;
            background-color: #f6ffed;
            border: 1px solid #b7eb8f;
            color: rgba(0, 0, 0, 0.65);
            text-shadow: 0 -1px 0 rgba(0,0,0,.12);
            padding: 0 8px;
            margin-left: 8px;
            font-size: .875rem;
        }

        /*60~80*/
        .quz-tag-2 {
            font-family: "Sarasa Mono HC", "Droid Sans Mono", "monospace", ".SF NS Mono", serif;
            border-radius: 1px;
            background-color: #e6f7ff;
            border: 1px solid #91d5ff;
            color: rgba(0, 0, 0, 0.65);
            text-shadow: 0 -1px 0 rgba(0,0,0,.12);
            padding: 0 8px;
            margin-left: 8px;
            font-size: .875rem;
        }

        /*40~60*/
        .quz-tag-3 {
            font-family: "Sarasa Mono HC", "Droid Sans Mono", "monospace", ".SF NS Mono", serif;
            border-radius: 1px;
            background-color: #fffbe6;
            border: 1px solid #ffe58f;
            color: rgba(0, 0, 0, 0.65);
            text-shadow: 0 -1px 0 rgba(0,0,0,.12);
            padding: 0 8px;
            margin-left: 8px;
            font-size: .875rem;
        }
        /*20~40*/
        .quz-tag-4 {
            font-family: "Sarasa Mono HC", "Droid Sans Mono", "monospace", ".SF NS Mono", serif;
            border-radius: 1px;
            background-color: #fff2f0;
            border: 1px solid #ffccc7;
            color: rgba(0, 0, 0, 0.65);
            text-shadow: 0 -1px 0 rgba(0,0,0,.12);
            padding: 0 8px;
            margin-left: 8px;
            font-size: .875rem;
        }
        /*0~20*/
        .quz-tag-5 {
            font-family: "Sarasa Mono HC", "Droid Sans Mono", "monospace", ".SF NS Mono", serif;
            border-radius: 1px;
            border: solid 1px rgba(61, 61, 61, 0.25);
            background: rgba(127, 127, 127, 0.14);
            color: rgba(0, 0, 0, 0.65);
            text-shadow: 0 -1px 0 rgba(0,0,0,.12);
            padding: 0 8px;
            margin-left: 8px;
            font-size: .875rem;
        }

        .my-note {
            padding: 10px 0 10px 0;
        }

        .returnHistory {
            cursor: pointer;
            text-decoration: none;
            position: absolute;
        }

        .note-area {
            margin-top: 12px;
            background-color: #e6efe3;
            resize: none;
            width: 658px;
            height: 173px;
            padding: 20px;
            border-radius: 8px;
            overflow-y: auto;
            font-size: 16px;
            letter-spacing: -.38px;
            line-height: 23px;
            outline: 0;
            border: solid 1px #9e9e9ea6;
        }
    </style>
    <script src="/echarts.min.js"></script>
    <script src="/easymde.min.js"></script>
    <link rel="stylesheet" href="/easymde.min.css">
    <title>题目列表</title>
</head>
<body style="background: #f5f7fa;">

<div style="margin: 20px auto 0; width: 1024px;">
    <input id="costArr" value="<%= JSON.stringify(costArr) %>" type="hidden" />
    <a href="/history-category-complex" class="returnHistory">返回练习列表</a>
    <h2 style="text-align: center"><%=cleanTitle(exercise.sheet.name)%></h2>
    <div style="text-align: center">
        <span><%=moment(exercise.updatedTime).format('YYYY 年 MM 月 DD 日 HH:mm')%></span>
    </div>
    <div style="text-align: center">
        <span>耗时<span style="color: blue"><%= Math.round(moment.duration(exercise.elapsedTime, 'seconds').asMinutes().toFixed(1)) %></span>分钟</span>
    </div>
    <div style="text-align: center; margin-top: 10px">
        <% for(let cSource of concernSourceCount) { %>
            <span class="quz-tag" style="margin-left: 0"> <%= cSource.key %>: <%= cSource.count %>题</span>
        <% } %>
    </div>
    <div style="padding-top: 20px;">
        <a class="solution-btn" target="_blank"
           href="https://www.fenbi.com/spa/tiku/report/exam/solution/xingce/xingce/<%= exercise.id %>/4">
            粉笔报告地址
        </a>
        <a class="solution-btn" target="_blank"
           href="https://tiku.fenbi.com/api/xingce/exercises/<%= exercise.id %>/pdf">
            导出pdf
        </a>
        <a id="expand-btn" class="solution-btn"
           href="javascript:foldAll(<%= concernQuestions.map(i => i.questionId) %>)">
            全部收起
        </a>
    </div>
    <p>
        做错<span class="wrong-count"><%= concernQuestions.filter(q => !q.correct).length %></span>题，
        做对但超时<span class="cost-count"><%= concernQuestions.filter(q => q.cost > costThreshold && q.correct).length %></span>题，
        错误率<span class="wrong-count"><%= (concernQuestions.filter(q => !q.correct).length / concernQuestions.length * 100).toFixed(1) + '%' %></span>，
        超时率<span class="cost-count"><%= (concernQuestions.filter(q => q.cost > costThreshold && q.correct).length / concernQuestions.length * 100).toFixed(1) + '%' %></span>
        <span class="comment">(耗时大于<%= costThreshold %>秒)</span>
    </p>
    <div id="costChart" style="width: auto;height:400px;"></div>
    <% for (let q of concernQuestions) { %>
        <div id="<%= q.questionId %>-tag" style="width: 200px;display: inline-block; white-space: nowrap;overflow: initial;">
            <% for (let i = 0; i < 4 && i < q.keypoints.concat(q.tags).length; i++) { %>
                <span class="quz-tag" style="margin-left: 0; border-radius: 0;"><%= q.keypoints.concat(q.tags)[i] %></span>
            <% } %>
        </div>

        <% if (q.wordList) {%>
        <div>
            <% for (let i = 0; i < q.wordList.length; i++) { %>
                <span class="quz-tag-word" style="margin-left: 0; border-radius: 0;"
                      onclick="fetchZjWord(`<%= q.wordList[i] %>`)"><%= q.wordList[i] %></span>
            <% } %>
        </div>
        <% } %>

        <div class="quz-item" id="<%= q.questionId %>">
            <div class="<%= ((q) => {
                if (!q.correct) return 'quz-title-wrong';
                if (q.correct && q.cost > costThreshold) return 'quz-title-timeout'
                return 'quz-title-correct';
            } )(q)%> noselect"
                 onclick="hideContent(<%= q.questionId %>)">
                <span><%= cleanTitle(q.source) %></span>
                <span class="quz-tag-group">
                    <span class="quz-tag-collect" style="display: <%=((hasCollect) => {
                        if (hasCollect) return 'inline';
                        else return 'none';
                    })(q.hasCollect)%>" id="quz-tag-collect-<%= q.questionId %>">收藏</span>
                    <span class="quz-tag-note" style="display: <%=((note) => {
                        if (note != null && note != '') return 'inline';
                        else return 'none';
                    })(q.note)%>" id="quz-tag-note-<%= q.questionId %>">笔记</span>

                    <span class="quz-tag-note-method" id="quz-tag-note-method-<%= q.questionId %>" style="display: <%=((note) => {
                        if (note && note.length && note.includes('[方法]')) return 'inline';
                        else return 'none';
                    })(q.note)%>">方法</span>
                    <span class="quz-tag-note-acc" id="quz-tag-note-acc-<%= q.questionId %>" style="display: <%=((note) => {
                        if (note && note.length && note.includes('[积累]')) return 'inline';
                        else return 'none';
                    })(q.note)%>">积累</span>
                    <span class="quz-tag-note-acc" id="quz-tag-note-example-<%= q.questionId %>" style="display: <%=((note) => {
                        if (note && note.length && note.includes('[例题]')) return 'inline';
                        else return 'none';
                    })(q.note)%>">例题</span>
                    <span class="quz-tag-note-rethink" id="quz-tag-note-rethink-<%= q.questionId %>" style="display: <%=((note) => {
                        if (note && note.length && note.includes('[反思]')) return 'inline';
                        else return 'none';
                    })(q.note)%>">反思</span>
                    <span class="quz-tag-note-rethink" id="quz-tag-note-summary-<%= q.questionId %>" style="display: <%=((note) => {
                        if (note && note.length && note.includes('[总结]')) return 'inline';
                        else return 'none';
                    })(q.note)%>">总结</span>

                    <span class="quz-tag">
                        <%= ((cost) => {
                            if (cost) return `耗时${cost}秒`;
                            return `未完成`
                        })(q.cost)%>
                    </span>
                    <span class="quz-tag-<%=((r) => {
                        if (r > 80) return 1;
                        if (r > 60) return 2;
                        if (r > 40) return 3;
                        if (r > 20) return 4;
                        return 5;
                    })(q.correctRatio)%>"> 正确率<%- q.correctRatio.toFixed(2)+ '%' %>
                    </span>
                    <span class="quz-tag"><%= q.totalCount %></span>
                </span>
            </div>
            <div class="quz-content-fold" id="quz-content-<%= q.questionId %>">
                <% if (q.material) { %>
                    <div class="quz-content"> <%- q.material %></div>
                <% } %>
                <span class="quz-idx"> <%- q.idx  %>.</span>
                <div class="quz-content"> <%- q.content %></div>
                <div class="quz-options">
                    <% for (let i = 0; i < q.options.length; i++) { %>
                        <% if (q.options[i].startsWith('<p>')) { %>
                            <div><%= ['A', 'B', 'C', 'D'][i] + '. ' %> <%- q.options[i].replace(/^<p>/g, '').replace(/<\/p>$/g, '') %></div>
                        <% } else { %>
                            <div><%= ['A', 'B', 'C', 'D'][i] + '. ' %> <%- q.options[i] %></div>
                        <% }%>
                    <% } %>
                </div>
            </div>
        </div>

        <div class="quz-other-fold" style="margin-top: -10px;margin-bottom: 38px;">
            <a class="solution-btn" id="show-ans-<%= q.questionId %>"
               href="javascript:showSolution(<%= q.questionId %>);">
                查看解析
            </a>
            <a class="solution-btn" id="show-comment-<%= q.questionId %>"
               href="javascript:showComment(<%= q.questionId %>);">
                查看评论
            </a>
            <a class="solution-btn" id="show-video-<%= q.questionId %>"
               href="javascript:showVideoSolution(<%= q.questionId %>);">
                视频解析
            </a>
            <a class="solution-btn" id="collect-<%= q.questionId %>"
               href="javascript:collect(<%= q.questionId %>);">
                <% if (q.hasCollect) { %>取消收藏<% } else { %>收藏<% } %>
            </a>
            <a class="solution-btn" id="copy-<%= q.questionId %>"
               href="javascript:copyContent(<%= q.questionId %>);">
                复制
            </a>
        </div>
        <video class="video-solution" id="video-<%= q.questionId %>" width="400" style="display: none; margin: -10px 0 20px 0;" controls></video>
        <div id="comment-<%= q.questionId %>" style="display: none;list-style: none;margin-bottom: 15px;"></div>
        <div class="quz-other-fold" id="ans-<%= q.questionId %>" style="padding: 0 30px;display:none">
            <div class="my-note">
                <strong>笔记:</strong>
                <a class="solution-btn" id="save-note-<%= q.questionId %>"
                   href="javascript:saveNote(<%= q.questionId %>);">
                    保存笔记
                </a>
                <br>
                <div style="margin-top: 20px">
                    <textarea id="mdNote-<%= q.questionId %>"></textarea>
                </div>

                <span id="note-<%= q.questionId %>" style="display: none;" class="note-area"><%= q.note %></span>
            </div>
            <div>
                我的选择: <%= q.myAnswer %>
            </div>
            <%- q.solution %>
        </div>
    <% } %>
</div>
</body>
<script>
    function showSolution(questionId) {
        let dis = document.getElementById(`ans-${questionId}`).style.display;
        if (dis === 'none') {
            document.getElementById(`ans-${questionId}`).style.display = "block";
            document.getElementById(`show-ans-${questionId}`).innerHTML = "收起解析";
        } else {
            document.getElementById(`ans-${questionId}`).style.display = "none";
            document.getElementById(`show-ans-${questionId}`).innerHTML = "查看解析";
        }
    }

    function showComment(questionId) {
        let comment = document.getElementById(`comment-${questionId}`);
        let dis = comment.style.display;
        if (dis === 'none') {
            if (comment.innerHTML) {
                comment.style.display = 'inline';
                document.getElementById(`show-comment-${questionId}`).innerHTML = "收起评论";
                return;
            }
            fetch(`/api/comment/${questionId}`, {
                method: 'GET'
            }).then(response => {
                if (response.status === 200) {
                    document.getElementById(`show-comment-${questionId}`).innerHTML = "收起评论";
                    return response.json();
                }
            }).then((datas) => {
                for (let {comment: c, createdTime, fiveGradeScore, likeCount} of datas) {
                    let li = document.createElement('li');
                    li.innerText = c + `(${likeCount})`;
                    li.style = 'margin-bottom: 10px;border: 1px solid #90909096;padding: 10px;';
                    comment.appendChild(li);
                }
                comment.style.display = 'block';
            });
        } else {
            document.getElementById(`show-comment-${questionId}`).innerHTML = "查看评论";
            document.getElementById(`comment-${questionId}`).style.display = "none";
        }
    }

    function showVideoSolution(questionId) {
        let video = document.getElementById(`video-${questionId}`);
        let source = document.createElement('source');
        source.type = 'video/mp4';
        let dis = video.style.display;
        if (dis === 'none') {
            if (video.currentSrc) {
                video.style.display = 'inline';
                return;
            }
            fetch(`/api/video/${questionId}`, {
                method: 'GET'
            }).then(response => {
                if (response.status === 200) {
                    document.getElementById(`show-video-${questionId}`).innerHTML = "收起视频";
                    return response.text();
                }
            }).then(url => {
                source.src = url;
                video.appendChild(source);
                video.style.display = 'inline';
            });
        } else {
            video.pause();
            video.style.display = 'none';
            document.getElementById(`show-video-${questionId}`).innerHTML = "视频解析";
        }
    }

    function collect(questionId) {
        let dis = document.getElementById(`quz-tag-collect-${questionId}`).style.display;
        if (dis === "none") {
            fetch(`/api/collect/${questionId}`, {
                method: 'POST'
            }).then(response => {
                if (response.status === 200) {
                    document.getElementById(`quz-tag-collect-${questionId}`).style.display = "inline";
                    document.getElementById(`collect-${questionId}`).innerHTML = "取消收藏";
                }
            })
        } else {
            fetch(`/api/collect/${questionId}`, {
                method: 'DELETE'
            }).then(response => {
                if (response.status === 200) {
                    document.getElementById(`quz-tag-collect-${questionId}`).style.display = "none";
                    document.getElementById(`collect-${questionId}`).innerHTML = "收藏";
                }
            })
        }
    }

    function copyContent(questionId) {
        let str = document.getElementById(questionId).innerHTML;

        function listener(e) {
            e.clipboardData.setData("text/html", str);
            e.clipboardData.setData("text/plain", str);
            e.preventDefault();
        }

        document.addEventListener("copy", listener);
        document.execCommand("copy");
        document.removeEventListener("copy", listener);
    }

    function hideContent(questionId, fold) {
        let unExpand = () => {
            document.getElementById(`quz-content-${questionId}`).style.display = "none";


            // 关闭解析
            document.getElementById(`show-ans-${questionId}`).style.display = "none";
            document.getElementById(`show-ans-${questionId}`).innerHTML = "查看解析";
            document.getElementById(`ans-${questionId}`).style.display = "none";

            // 关闭评论
            document.getElementById(`show-comment-${questionId}`).style.display = "none";
            document.getElementById(`show-comment-${questionId}`).innerHTML = "查看评论";
            document.getElementById(`comment-${questionId}`).style.display = "none";


            // 关闭视频
            document.getElementById(`show-video-${questionId}`).style.display = "none";
            document.getElementById(`show-video-${questionId}`).innerHTML = "视频解析";
            let video = document.getElementById(`video-${questionId}`);
            video.pause();
            video.style.display = 'none';

            document.getElementById(`collect-${questionId}`).style.display = "none";
            document.getElementById(`copy-${questionId}`).style.display = "none";
        };

        let expand = () => {
            document.getElementById(`quz-content-${questionId}`).style.display = "block";
            document.getElementById(`show-ans-${questionId}`).style.display = "inline";
            document.getElementById(`show-comment-${questionId}`).style.display = "inline";
            document.getElementById(`show-video-${questionId}`).style.display = "inline";
            document.getElementById(`collect-${questionId}`).style.display = "inline";
            document.getElementById(`copy-${questionId}`).style.display = "inline";
        }
        if (fold != null && fold === true) {
            expand();
        } else if (fold != null && fold === false) {
            unExpand();
        } else {
            let dis = document.getElementById(`quz-content-${questionId}`).style.display;
            if (dis === 'none') {
                expand();
            } else {
                unExpand();
            }
        }
    }

    // 下一步的动作
    var fold = false;

    function foldAll(...questionIds) {
        if (!fold) {
            document.getElementById(`expand-btn`).innerHTML = "全部展开";
        } else {
            document.getElementById(`expand-btn`).innerHTML = "全部收起";
        }
        questionIds.forEach(questionId => {
            hideContent(questionId, fold)
        });
        fold = !fold;
    }
    foldAll(<%= concernQuestions.map(i => i.questionId) %>)

    let mdOptions = {
        autofocus: true,
        forceSync: true,
        autoRefresh: {
            delay: 300,
        },
        hideIcons: ["guide", "heading"],
        minHeight: "250px",
        maxHeight: "250px",
        parsingConfig: {
            allowAtxHeaderWithoutSpace: true,
            strikethrough: false,
            underscoresBreakWords: true,
        },
        placeholder: "请输入笔记",
        showIcons: ["code", "table"],
        spellChecker: false,
        status: false,
        styleSelectedText: false,
        sideBySideFullscreen: false,
        syncSideBySidePreviewScroll: false,
        tabSize: 4,
        // toolbar: false,
        toolbarTips: false,

    };

    var mdeMap = {};
    function genMdNote(...questionIds) {
        questionIds.forEach(questionId => {
            let easyMDE = new EasyMDE(Object.assign({}, mdOptions, {element: document.getElementById(`mdNote-${questionId}`)}));
            mdeMap[questionId] = easyMDE;
            let content = document.getElementById(`note-${questionId}`).innerText;
            if(content.length > 0) {
                easyMDE.value(content);
                easyMDE.togglePreview();
            }
        });
    }

    function saveNote(questionId) {
        let noteContent = mdeMap[questionId].value();
        fetch(`/api/saveNote/${questionId}`, {
            method: 'POST',
            headers: {
                'content-type': 'application/json'
            },
            body: JSON.stringify({
                noteContent
            })
        }).then(response => {
            if (response.status === 200) {
                if (noteContent && noteContent.includes('[方法]')) {
                    document.getElementById(`quz-tag-note-method-${questionId}`).style.display = "inline";
                } else {
                    document.getElementById(`quz-tag-note-method-${questionId}`).style.display = "none";
                }

                if (noteContent && noteContent.includes('[积累]')) {
                    document.getElementById(`quz-tag-note-acc-${questionId}`).style.display = "inline";
                } else {
                    document.getElementById(`quz-tag-note-acc-${questionId}`).style.display = "none";
                }

                if (noteContent && noteContent.includes('[例题]')) {
                    document.getElementById(`quz-tag-note-example-${questionId}`).style.display = "inline";
                } else {
                    document.getElementById(`quz-tag-note-example-${questionId}`).style.display = "none";
                }
                if (noteContent && noteContent.includes('[反思]')) {
                    document.getElementById(`quz-tag-note-rethink-${questionId}`).style.display = "inline";
                } else {
                    document.getElementById(`quz-tag-note-rethink-${questionId}`).style.display = "none";
                }

                if (noteContent && noteContent.includes('[总结]')) {
                    document.getElementById(`quz-tag-note-summary-${questionId}`).style.display = "inline";
                } else {
                    document.getElementById(`quz-tag-note-summary-${questionId}`).style.display = "none";
                }


                return response.json();
            } else {
                alert('笔记保存失败！');
            }
        })
    }

    genMdNote(<%= concernQuestions.map(i => i.questionId) %>)

    let myChart = echarts.init(document.getElementById('costChart'));
    let costDatas = JSON.parse(document.getElementById('costArr').value);
    let sort = false;
    // 指定图表的配置项和数据
    let option = (datas) => ({
        title: {
            x:'center',
            y:'top',
            // textAlign:'center',
            text: '习题耗时和难度分析'
        },
        tooltip: {
            show: true,
            trigger: 'axis',
            // axisPointer: {
            //     type: "shadow"
            // }
        },
        grid: [{
            height: '35%',
        }, {
            top: '60%',
            height: '30%',
        }],
        axisPointer: {
            link: {xAxisIndex: 'all'}
        },
        xAxis: [{
            data: datas.map(i => i.idx),
            // type: 'category',
            axisLine: {onZero: true},
            gridIndex: 0
        }, {
            data: datas.map(i => i.idx),
            // type: 'category',
            axisLine: {onZero: true},
            gridIndex: 1,
        }],
        yAxis: [{
            gridIndex: 0,
            type: 'value',
            // name: '耗时',
            // min: 0,
            // max: 250,
            // interval: 50,
            axisLabel: {
                formatter: '{value} s'
            },
            splitLine: {
                show: false
            },
            // axisPointer: {
            //     show: true,
            //     label: {
            //         formatter: '耗时 {value} 秒',
            //     }
            // }
        }, {
            gridIndex: 0,
            type: 'value',
            name: '累计耗时',
            min: 0,
            max: datas.length * <%= avg(costArr.map(i => i.cost+1)) %>,
            axisLabel: {
                formatter: '{value} s'
            },
            inverse: true,
        }, {
            gridIndex: 1,
            type: 'value',
            // name: '难度',
            min: 0,
            max: 100,
            // interval: 50,
            axisLabel: {
                formatter: '{value} %'
            },
            splitLine: {
                show: false
            },
        }],
        series: [{
            name: '耗时',
            type: 'bar',
            data: datas.map(item => item.cost),
            markLine: {
                silent: true,
                itemStyle: {
                    normal: {
                        lineStyle: {
                            // type: 'solid',
                        },
                        label: {
                            show: true,
                            position: 'end'
                        }
                    }
                },
                // silent: true,
                data: [{
                    name: '80分位数',
                    yAxis: <%= percentile(80, costArr.map(i => i.cost)) %>
                }]
            }
        }, {
            name: '累计耗时',
            type: 'line',
            smooth: true,
            data: datas.map(item => item.cost).map(((sum => value => sum += value)(0))),
            yAxisIndex: 1,
            areaStyle: {
                color: "rgb(51,171,106, 0.4)"
            },
        }, {
            name: '累计耗时(理想)',
            type: 'line',
            smooth: true,
            data: datas.map(item => item.cost).map(((sum => value => sum += (30/35*60))(0))),
            yAxisIndex: 1,
            areaStyle: {
                color: "rgba(58,77,233,0.3)"
            },
        }, {
            name: '难度',
            type: 'bar',
            xAxisIndex: 1,
            yAxisIndex: 2,
            data: datas.map(item => item.correctRatio),
            markLine: {
                silent: true,
                itemStyle: {
                    normal: {
                        lineStyle: {
                            // type: 'solid',
                        },
                        label: {
                            show: true,
                            position: 'end'
                        }
                    }
                },
                // silent: true,
                data: [{
                    name: '平均难度',
                    yAxis: <%= avg(costArr.map(i => i.correctRatio)) %>
                }]
            }
        }],
        visualMap: [{
            seriesIndex: 0,
            orient:'horizontal',
            left: 'center',
            top: '55%',
            pieces: [{
                gt: 0,
                lte: 60,
                color: '#096'
            }, {
                gt: 60,
                lte: 80,
                color: '#628de3'
            }, {
                gt: 80,
                lte: 100,
                color: '#f1b448'
            }, {
                gt: 100,
                lte: 120,
                color: '#fa6e6e'
            }, {
                gt: 120,
                lte: 150,
                color: '#ad0000'
            }, {
                gt: 150,
                color: '#000000'
            }],
            outOfRange: {
                color: '#999'
            }
        }, {
            seriesIndex: 3,
            orient:'horizontal',
            left: 'center',
            pieces: [{
                gt: 0,
                lte: 20,
                color: '#000000'

            }, {
                gt: 20,
                lte: 30,
                color: '#ad0000'
            }, {
                gt: 30,
                lte: 50,
                color: '#fa6e6e'

            }, {
                gt: 50,
                lte: 60,
                color: '#f1b448'
            }, {
                gt: 60,
                lte: 75,
                color: '#628de3'
            }, {
                gt: 75,
                color: '#096'
            }],
            outOfRange: {
                color: '#999'
            },
        }],
        toolbox: {
            right: 50,
            show : true,
            feature : {
                myTool2:{//自定义按钮 danielinbiti,这里增加，selfbuttons可以随便取名字
                    show:true,//是否显示
                    title:'按耗时排序', //鼠标移动上去显示的文字
                    icon: 'image://data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iaXNvLTg4NTktMSI/Pg0KPCEtLSBHZW5lcmF0b3I6IEFkb2JlIElsbHVzdHJhdG9yIDE5LjAuMCwgU1ZHIEV4cG9ydCBQbHVnLUluIC4gU1ZHIFZlcnNpb246IDYuMDAgQnVpbGQgMCkgIC0tPg0KPHN2ZyB2ZXJzaW9uPSIxLjEiIGlkPSJDYXBhXzEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHg9IjBweCIgeT0iMHB4Ig0KCSB2aWV3Qm94PSIwIDAgNTEyIDUxMiIgc3R5bGU9ImVuYWJsZS1iYWNrZ3JvdW5kOm5ldyAwIDAgNTEyIDUxMjsiIHhtbDpzcGFjZT0icHJlc2VydmUiPg0KPGc+DQoJPGc+DQoJCTxnPg0KCQkJPHJlY3QgeD0iMi4zNDQiIHk9IjQ4MCIgd2lkdGg9IjM4NCIgaGVpZ2h0PSIzMiIvPg0KCQkJPHJlY3QgeD0iMi4zNDQiIHk9IjM4NCIgd2lkdGg9IjMyMCIgaGVpZ2h0PSIzMiIvPg0KCQkJPHJlY3QgeD0iMi4zNDQiIHk9IjI4OCIgd2lkdGg9IjI1NiIgaGVpZ2h0PSIzMiIvPg0KCQkJPHJlY3QgeD0iMi4zNDQiIHk9IjE5MiIgd2lkdGg9IjE5MiIgaGVpZ2h0PSIzMiIvPg0KCQkJPHJlY3QgeD0iMi4zNDQiIHk9Ijk2IiB3aWR0aD0iMTI4IiBoZWlnaHQ9IjMyIi8+DQoJCQk8cmVjdCB4PSIyLjM0NCIgd2lkdGg9IjY0IiBoZWlnaHQ9IjMyIi8+DQoJCQk8cG9seWdvbiBwb2ludHM9IjQ4Ny4wMzIsNDI4LjY4OCA0NjYuMzQ0LDQ0OS4zNzYgNDY2LjM0NCwxMjggNDM0LjM0NCwxMjggNDM0LjM0NCw0NDkuMzc2IDQxMy42NTYsNDI4LjY4OCAzOTEuMDMyLDQ1MS4zMTIgDQoJCQkJNDUwLjM0NCw1MTAuNjI0IDUwOS42NTYsNDUxLjMxMiAJCQkiLz4NCgkJCTxyZWN0IHg9IjQzNC4zNDQiIHk9IjY0IiB3aWR0aD0iMzIiIGhlaWdodD0iMzIiLz4NCgkJCTxyZWN0IHg9IjQzNC4zNDQiIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiIvPg0KCQk8L2c+DQoJPC9nPg0KPC9nPg0KPGc+DQo8L2c+DQo8Zz4NCjwvZz4NCjxnPg0KPC9nPg0KPGc+DQo8L2c+DQo8Zz4NCjwvZz4NCjxnPg0KPC9nPg0KPGc+DQo8L2c+DQo8Zz4NCjwvZz4NCjxnPg0KPC9nPg0KPGc+DQo8L2c+DQo8Zz4NCjwvZz4NCjxnPg0KPC9nPg0KPGc+DQo8L2c+DQo8Zz4NCjwvZz4NCjxnPg0KPC9nPg0KPC9zdmc+DQo=',
                    onclick:function() {
                        sort = !sort;
                        let d = JSON.parse(document.getElementById('costArr').value);
                        if (sort) {
                            myChart.setOption(option(d.sort((a,b) => {return a.cost - b.cost;})), true);
                        } else {
                            myChart.setOption(option(d), true);
                        }
                    }
                },
                myTool3:{//自定义按钮 danielinbiti,这里增加，selfbuttons可以随便取名字
                    show:true,//是否显示
                    title:'按难度排序', //鼠标移动上去显示的文字
                    icon: 'image://data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iaXNvLTg4NTktMSI/Pg0KPCEtLSBHZW5lcmF0b3I6IEFkb2JlIElsbHVzdHJhdG9yIDE5LjAuMCwgU1ZHIEV4cG9ydCBQbHVnLUluIC4gU1ZHIFZlcnNpb246IDYuMDAgQnVpbGQgMCkgIC0tPg0KPHN2ZyB2ZXJzaW9uPSIxLjEiIGlkPSJDYXBhXzEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHg9IjBweCIgeT0iMHB4Ig0KCSB2aWV3Qm94PSIwIDAgNTEyIDUxMiIgc3R5bGU9ImVuYWJsZS1iYWNrZ3JvdW5kOm5ldyAwIDAgNTEyIDUxMjsiIHhtbDpzcGFjZT0icHJlc2VydmUiPg0KPGc+DQoJPGc+DQoJCTxnPg0KCQkJPHJlY3QgeD0iMi4zNDQiIHk9IjQ4MCIgd2lkdGg9IjM4NCIgaGVpZ2h0PSIzMiIvPg0KCQkJPHJlY3QgeD0iMi4zNDQiIHk9IjM4NCIgd2lkdGg9IjMyMCIgaGVpZ2h0PSIzMiIvPg0KCQkJPHJlY3QgeD0iMi4zNDQiIHk9IjI4OCIgd2lkdGg9IjI1NiIgaGVpZ2h0PSIzMiIvPg0KCQkJPHJlY3QgeD0iMi4zNDQiIHk9IjE5MiIgd2lkdGg9IjE5MiIgaGVpZ2h0PSIzMiIvPg0KCQkJPHJlY3QgeD0iMi4zNDQiIHk9Ijk2IiB3aWR0aD0iMTI4IiBoZWlnaHQ9IjMyIi8+DQoJCQk8cmVjdCB4PSIyLjM0NCIgd2lkdGg9IjY0IiBoZWlnaHQ9IjMyIi8+DQoJCQk8cG9seWdvbiBwb2ludHM9IjQ4Ny4wMzIsNDI4LjY4OCA0NjYuMzQ0LDQ0OS4zNzYgNDY2LjM0NCwxMjggNDM0LjM0NCwxMjggNDM0LjM0NCw0NDkuMzc2IDQxMy42NTYsNDI4LjY4OCAzOTEuMDMyLDQ1MS4zMTIgDQoJCQkJNDUwLjM0NCw1MTAuNjI0IDUwOS42NTYsNDUxLjMxMiAJCQkiLz4NCgkJCTxyZWN0IHg9IjQzNC4zNDQiIHk9IjY0IiB3aWR0aD0iMzIiIGhlaWdodD0iMzIiLz4NCgkJCTxyZWN0IHg9IjQzNC4zNDQiIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiIvPg0KCQk8L2c+DQoJPC9nPg0KPC9nPg0KPGc+DQo8L2c+DQo8Zz4NCjwvZz4NCjxnPg0KPC9nPg0KPGc+DQo8L2c+DQo8Zz4NCjwvZz4NCjxnPg0KPC9nPg0KPGc+DQo8L2c+DQo8Zz4NCjwvZz4NCjxnPg0KPC9nPg0KPGc+DQo8L2c+DQo8Zz4NCjwvZz4NCjxnPg0KPC9nPg0KPGc+DQo8L2c+DQo8Zz4NCjwvZz4NCjxnPg0KPC9nPg0KPC9zdmc+DQo=',
                    onclick:function() {
                        sort = !sort;
                        let d = JSON.parse(document.getElementById('costArr').value);
                        if (sort) {
                            myChart.setOption(option(d.sort((a,b) => {return b.correctRatio - a.correctRatio;})), true);
                        } else {
                            myChart.setOption(option(d), true);
                        }
                    }
                }
            }
        },

    });

    // 使用刚指定的配置项和数据显示图表。
    myChart.setOption(option(costDatas));


    let idxMap = {};
    function genIdxMap(idxStr) {
        let questions = JSON.parse(idxStr);
        questions.forEach(q => {
            idxMap[q.idx] = q.questionId + '-tag';
        });
    }

    genIdxMap(`<%- JSON.stringify(concernQuestions.map(q => ({idx: q.idx, questionId: q.questionId})))%>`);
    myChart.on('click', function (params) {
        location.hash = idxMap[params.name];
    });

    function fetchZjWord(word) {
        fetch(`/api/zj`, {
            method: 'POST',
            headers: {
                'content-type': 'application/json'
            },
            body: JSON.stringify({
                word: word,
            })
        }).then(response => {
            if (response.status === 200) {
                return response.text();
            }
        }).then(res => {
            window.open(res, "_blank");
        })
    }

</script>
</html>